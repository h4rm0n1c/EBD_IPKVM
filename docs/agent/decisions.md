# Decisions (running)

- 2026-01-31: Move capture/line packetization to core1 and reserve core0 for CDC I/O with an SPSC queue bridging cores.
- 2026-02-01: Split USB CDC into separate stream (CDC0) and control/status (CDC1) interfaces so binary video traffic never interleaves with ASCII commands.
- 2026-02-01: Define core utilization metrics as active USB/capture/TX queue work time (not full loop occupancy) to better reflect pipeline load.
- 2026-02-01: Only accrue utilization time when USB/capture/TX routines make progress so idle loops report near-zero activity.
- 2026-02-02: Assign ADB RECV to GPIO7 (via 74LVC245) and ADB XMIT to GPIO8 (via ULN2803) on the shared ADB data line.
- 2026-01-30: Add a runtime capture mode toggle that swaps between 30 fps test capture and continuous 60 fps streaming.
- 2026-01-30: Default capture mode to continuous 60 fps streaming to prioritize long-form testing runs.
- 2026-01-30: Default host capture output to PBM for compact 1-bpp frames, keeping PGM as an opt-in option for 8-bit output.
- 2026-01-30: Add an RLE encoding option for scanline payloads using bit 15 of `payload_len` as a flag, plus CDC commands to enable/disable it while retaining raw payload compatibility; default to RLE-on for testing.
- 2026-01-28: Insert an 18-PIXCLK delay after XOFF before sampling each line so the captured window starts in active video instead of the left porch.
- 2026-01-27: Byte-swap each 32-bit PIO RX FIFO word in firmware before USB enqueue so host unpacking receives correctly ordered pixels.
- 2026-01-27: Phase-lock PIXCLK after HSYNC and pre-roll the falling-edge capture so the first wait sees a real edge (prevents 1-pixel phase slips).
- 2026-01-27: For PIXCLK rising-edge capture, force PIXCLK low before the first `wait 1`; for falling-edge capture, wait high→low before sampling each bit to prevent phase-dependent jitter.
- 2026-01-27: Capture a fixed (YOFF+ACTIVE) number of lines and finalize frames on DMA completion instead of VSYNC to avoid variable line counts.
- 2026-01-27: Anchor HSYNC with a full high→low→high sequence and reduce XOFF by 16 PIXCLKs to align horizontal sampling.
- 2026-01-27: Anchor HSYNC on per-mode edges (falling for classic default) and retune XOFF to 157 PIXCLK cycles with a post-edge sampling delay to avoid blanking capture.
- 2026-01-27: End frames on VSYNC and use ping-pong framebuffers so capture timing stays locked while USB packetization runs in the main loop.
- 2026-01-27: Debounce VSYNC edges and only mark frames for transmit when the USB TX path is idle to prevent backpressure skips.
- 2026-01-27: Capture each frame with a single DMA transfer into a contiguous buffer and abort on VSYNC to avoid per-line DMA timing hazards.
- 2026-01-27: When a captured frame has fewer than `CAP_YOFF_LINES + CAP_ACTIVE_H` lines, derive the start line from the end of the capture so we still transmit a full active region.
- 2026-01-29: Lock classic capture to HSYNC falling + PIXCLK rising and remove runtime edge toggles/alternate PIO programs to favor the proven default path.
- 2026-01-25: Repository initialised with docs-first workflow and agent documentation scaffold.
- 2026-01-26: Use GPIO9 (via ULN2803) as an active-high ATX PS_ON output; add CDC commands for PS_ON control, BOOTSEL, and watchdog reset.
- 2026-01-26: Use polling-based edge sampling for GPIO diagnostics to avoid interrupt overload on PIXCLK while still confirming activity.
- 2026-01-26: Add a force-capture command to bypass VSYNC gating for troubleshooting capture stalls.
- 2026-01-26: Add a synthetic test-frame command to validate USB streaming when capture remains stalled.
- 2026-01-26: Skip force-capture fallback when explicitly running synthetic test frames.
- 2026-01-26: Add a probe packet command to verify CDC byte delivery independently of framing.
- 2026-01-26: Emit a probe packet alongside synthetic test frames for immediate CDC verification.
- 2026-01-26: Add an on-demand debug command to expose CDC/queue state without a scope.
- 2026-01-25: Switch line-capture trigger to HSYNC falling edge to validate sync polarity.
- 2026-01-25: Set horizontal skip to 178 PIXCLK cycles after HSYNC falling edge based on VCD sweep results.
- 2026-01-25: Add runtime CDC toggles for HSYNC/VSYNC edge selection to speed capture validation.
- 2026-01-25: Add runtime CDC toggle for PIXCLK edge selection to diagnose sampling phase.
