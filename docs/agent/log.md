# Log (running)

- 2026-02-09: Move VSYNC edge handling onto a raw IO_IRQ_BANK0 handler so ADB's raw IRQ usage can't override the VSYNC callback, reducing intermittent sync loss while ADB is active.
- 2026-02-12: Add a shared IO_IRQ_BANK0 dispatcher so VSYNC + ADB acknowledge all pending GPIO IRQ bits in one handler, preventing IRQ storms that can break capture.
- 2026-02-12: Ensure IO_IRQ_BANK0 dispatcher acknowledges all pending GPIO IRQ bits (even for unregistered pins) before dispatching to registered handlers, preventing retrigger storms.
- 2026-02-12: Add ADB debug counters for reg0 fills/SRQ gating/rx-gate events and acknowledge the ADB GPIO rise IRQ in the raw handler to avoid stuck IRQs during coexistence debugging.
- 2026-02-08: Switched ADB GPIO rising-edge detection to a raw IO_IRQ_BANK0 handler so it no longer conflicts with the VSYNC GPIO callback, matching hootswitch’s IRQ strategy and restoring ADB attention/rise detection.
- 2026-02-08: Acknowledge all ADB GPIO IRQ event bits in the raw handler to prevent stuck IRQs (possible CDC freeze) while still latching rise events.
- 2026-02-08: Set the ADB TX PIO pin direction/output mask on init (hootswitch-style) so the state machine can actively drive GPIO12 through the ULN2803.
- 2026-02-08: Add ADB Talk debug counters (empty responses + total bytes) to confirm when Talk responses are actually emitted on the wire.
- 2026-02-08: Disable the ADB GPIO rise interrupt inside the raw IRQ handler (hootswitch-style) to avoid repeated IRQ storms that can freeze the core.
- 2026-02-08: Emit the CDC1 debug block as a single write (retrying when buffer space is low) and pause periodic status while a debug dump is pending so Talk counters reliably print.
- 2026-02-08: Emit the periodic CDC1 status lines as a single buffered block to reduce control-endpoint churn and avoid partial writes when the host is slow to read.
- 2026-02-08: Switch CDC1 debug/status output to a queued, chunked write path so large debug blocks can drain without stalling the main loop or starving capture/USB handling.
- 2026-02-08: Re-enable CDC1 status/debug output during capture so control/status traffic remains available while the stream is active; rely on queued chunking to avoid blocking.
- 2026-02-09: Make capture byte-swap post-processing DMA non-blocking and gate new capture starts until the postprocess pass completes, keeping core1 loop work off the hot path.
- 2026-02-09: Batch line enqueueing on core1 to 8 lines per loop iteration to limit queue churn and preserve capture/ADB servicing time.
- 2026-02-09: Revert bulk line coalescing in the stream writer while investigating horizontal roll during capture.
- 2026-02-10: Reworked CDC debug/status output to use labeled prefixes and clearer fields, and lowered the picocom helper baud rate to 57600 with doc updates.
- 2026-02-10: Simplified CDC1 output handling to emit debug/status lines directly without queued buffering so the console output is less likely to be dropped.
- 2026-02-10: Switched CDC1 writes to a blocking/chunked loop to ensure full lines are delivered and merged status into a single line to reduce partial output.
- 2026-02-10: Added EP0 vendor control commands for capture control, moved capture-related CDC1 commands to EP0, and updated host tooling/docs accordingly.
- 2026-02-10: Removed legacy capture diagnostics/toggles (force/test frame, VSYNC/mode toggle, GPIO diag) from EP0 control and host tooling.
- 2026-02-10: Removed capture test-mode and VSYNC-edge toggle codepaths from the video core to lock continuous capture and reduce runtime toggle overhead.
- 2026-02-10: Added a timeout to CDC1 blocking writes so control console disconnects or flow stalls don't hang the main loop.
- 2026-02-05: Implemented the core1 ADB bus state machine with Talk/Listen parsing, register storage for keyboard/mouse, SRQ gating, and CDC2 queue draining into register 0 payloads.
- 2026-02-05: Added CDC2 ASCII-to-ADB keycode mapping and aligned ADB event decoding to the adb_queue union layout.
- 2026-02-05: Gate ADB RX sampling on a rising edge and keep the RX state machine disabled while the bus is held low to avoid false RX activity.
- 2026-02-05: Note the observed Mac power-up ADB line behavior (~3.979 ms low pulse after rising high, first Talk traffic ~1 ms later).
- 2026-02-05: Only latch ADB RX activity when a command/listen payload completes to avoid RX-seen spam from idle noise.
- 2026-02-05: Replace the ADB PIO programs with hootswitch’s device-side bus PIO implementation and add its GPLv3 license under licenses/.
- 2026-02-05: Shift SRQ pulse timing to the hootswitch device-side PIO flow instead of software-timed pulses.
- 2026-02-05: Align attention handling to hootswitch’s GPIO rising-edge flow (IRQ-driven) to decide reset vs command.
- 2026-02-05: Align command/SRQ handling to hootswitch’s stop-bit + GPIO rise flow before executing Talk/Listen.
- 2026-02-05: Track SRQ pending state with a hootswitch-style SRQ bitfield to simplify SRQ gating decisions.
- 2026-02-05: Align ADB GPIO rising-edge handling to hootswitch’s setup flow so short attention/stop-bit rises execute immediately instead of waiting on an IRQ.
- 2026-02-05: Match hootswitch SRQ gating so non-target Talk $0 commands still emit SRQ when any device has pending data.
- 2026-02-05: Adopt hootswitch’s randomized reg3 address nibble for Talk responses to match address-resolution behavior.
- 2026-02-05: Add hootswitch-style talk-register locking so Talk payloads are protected during updates.
- 2026-02-05: Honor hootswitch reg3 handler ID gating by suppressing reg3 Talk when the handler is 0xFF.
- 2026-02-05: Gate SRQ pending flags on reg0 queueing only when SRQ is enabled, matching hootswitch device behavior.
- 2026-02-05: Match hootswitch Talk register length rules by treating Listen writes under 2 bytes as empty and clearing SRQ for reg0.
- 2026-02-05: Ignore reg3 Listen writes shorter than 2 bytes, matching hootswitch’s reg3 length handling.
- 2026-02-05: Add hootswitch-style lock/collision counters and expose them via the CDC debug status line.
- 2026-02-05: Source reg3 handler IDs via a callback to allow hootswitch-style dynamic handler selection.
- 2026-02-05: Drain reg0 from per-device pop callbacks only when empty and the lock is available (hootswitch queue-drain semantics).
- 2026-02-05: Add setters to bind per-device reg0 pop and handler-id callbacks, enabling hootswitch-style driver-owned queue draining.
- 2026-02-05: Buffer mouse reports into a per-device reg0 queue so Talk 0 drain matches hootswitch queue semantics.
- 2026-02-05: Buffer keyboard reg0 reports into a per-device queue so Talk 0 drain mirrors hootswitch queue semantics.
- 2026-02-05: Allow reg0 pop callbacks to carry a queue context pointer for hootswitch-style driver-owned queues.
- 2026-02-06: Wired ADB driver callbacks (handler ID + reg0 pop) through a new adb_driver layer, and shifted keyboard/mouse queue handling into that driver so callbacks remain driver-owned across bus resets.
- 2026-02-06: Added hootswitch-style ADB debug counters (attention, short attention, reset, abort, error, abort timestamp) and surfaced them in the CDC debug output.
- 2026-02-06: Added hootswitch-style handler ID validation in adb_driver (keyboard allows 0x01-0x03; mouse allows 0x01/0x02/0x04) to mirror per-device handler policies.
- 2026-02-06: Clear SRQ flags when reg3 Listen disables SRQ on address change, matching hootswitch’s SRQ bitfield handling.
- 2026-02-06: Document a hootswitch parity checklist in the ADB implementation plan to track device-side extraction scope.
- 2026-02-06: Update the ADB implementation plan with a hootswitch port-status summary and align CDC2 click input docs with Ctrl+R behavior.
- 2026-02-06: Add driver callbacks for ADB Listen/Flush so device-side behavior matches hootswitch’s driver notification flow.
- 2026-02-06: Documented an ADB validation checklist (scope + CDC2 input steps) to guide hardware parity verification.
- 2026-02-07: Restore pico/rand.h usage for seeding the ADB reg3 address table and link pico_rand in CMake so the header is on the include path.
- 2026-02-08: Move capture byte-swap into a post-capture DMA pass so core1 can transmit scanlines directly from the capture buffer.
- 2026-02-03: Added ADB event queue + core1 service stub plus CDC2 ADB test input for keyboard/mouse injection.
- 2026-02-03: Added scripts/setup_opt_references.sh to install /opt reference corpora including hootswitch and ADB miscdocs.
- 2026-02-03: Updated ADB documentation to reflect hootswitch-based bus planning, AppleCore naming, and GPIO6/12 wiring.
- 2026-02-04: Added an ADB PIO RX/TX skeleton on PIO1 with a core1 service stub plus a rate-limited RX activity indicator for CDC debug output.
- 2026-02-04: Added an internal pull-up and RX FIFO drain cap/restart to keep ADB PIO sampling stable on noisy or floating lines.
- 2026-02-04: Gate ADB RX sampling until GPIO6 is high to avoid false RX activity and lockups when the bus is held low on power-up.
- 2026-02-04: Noted the ~4 ms ADB reset pulse seen just before initial Talk traffic on power-on as a potential sync reference.
- 2026-02-02: Added --no-read and --no-setup options to scripts/cdc_cmd.py for send-only CDC commands.
- 2026-02-02: Added flash/build and serial console helper scripts under scripts/ for Pico workflows.
- 2026-02-02: Updated the ADB implementation plan to split RX/TX into separate PIO programs and to ignore local TX on the shared ADB line except during loopback validation.
- 2026-02-02: Updated the ADB plan to refer to core1 as KVMCore and to include a rate-limited ADB RX indicator on the CDC test channel.
- 2026-02-02: Noted that ADB validation should cross-check the reference implementations available under /opt/adb.

- 2026-02-02: Updated README with ADB pins, corrected capture geometry, and clarified CDC stream/control interfaces plus host helper defaults.
- 2026-02-01: Added core0/core1 utilization counters to the firmware status output to support time-budgeting work on the video core.
- 2026-02-01: Refined core0/core1 utilization counters to track active USB/capture/TX queue work time instead of full loop occupancy.
- 2026-02-01: Count utilization only when USB/capture/TX routines perform work, avoiding idle-loop inflation.
- 2026-02-01: Split USB CDC into stream (CDC0) and control/status (CDC1) interfaces so status traffic no longer shares the video stream.
- 2026-02-01: Updated host Python tooling to target CDC0 for the stream and CDC1 for control commands by default.
- 2026-02-01: Documented how to identify CDC0/CDC1 in Linux via interface strings and /dev/serial/by-id symlinks.
- 2026-02-02: Documented /opt/adb reference locations in agents.md for local ADB research sources.
- 2026-02-01: Avoid partial CDC1 status writes so log lines don't interleave when control FIFO is tight.
- 2026-02-02: Captured external ADB implementation references and Apple docs links in notes for future input-device emulation work.
- 2026-02-01: Split CDC1 debug/status output into shorter lines so the control interface can emit updates reliably.
- 2026-02-01: Emit CRLF on CDC1 output to keep terminal line breaks aligned across host serial tools.
- 2026-02-01: Disabled frame file writes when streaming raw host data so raw capture no longer fills disks with PGM/PBM output.
- 2026-02-01: Modularized core0 CDC/command handling and core1 capture/encode flow into app_core/video_core with shared stream protocol and core bridge helpers.
- 2026-01-31: Split capture/line encoding onto core1 with a lock-free TX queue to keep core0 focused on CDC I/O and command parsing.
- 2026-01-30: Added a CDC mode toggle for 30 fps test capture versus continuous ~60 fps streaming.
- 2026-01-30: Defaulted capture mode to continuous ~60 fps streaming for testing.
- 2026-01-30: Made raw stream mode in `host_recv_frames.py` run continuously and silence periodic debug output.
- 2026-01-30: Added optional raw 8-bit stream output to `host_recv_frames.py` and switched default output to PGM.
- 2026-01-30: Switched host test output to compact PBM by default with a --pgm fallback for 8-bit frames.
- 2026-01-30: Documented ffmpeg palette generation and GIF assembly commands for host frame captures.
- 2026-01-30: Added optional RLE packet encoding with a CDC toggle and updated host decoding to handle variable-length line payloads (default RLE on).
- 2026-01-30: Added per-frame host-side compression stats (payload vs raw bytes, RLE line counts) to visualize RLE effectiveness.
- 2026-01-30: Switched host compression ratio readout to a percentage for easier scanning.
- 2026-01-29: Lock classic line capture to HSYNC falling + PIXCLK rising and remove runtime edge toggles/program variants to simplify the PIO program set.
- 2026-01-28: Delayed line capture start by 18 PIXCLKs after XOFF to shift sampling into active video and preserve the rightmost pixels.
- 2026-01-27: Switched capture to VSYNC-ended frame boundaries with ping-pong framebuffers and main-loop line packetization to prevent line-count drift.
- 2026-01-27: Added VSYNC debounce and TX-idle gating so frame delivery stays monotonic under backpressure.
- 2026-01-27: Documented /opt reference relevance (MacDevDocs, Pico SDK, PicoHTTPServer) for future KVM work.
- 2026-01-27: Expanded /opt reference notes with SigrokPico RLE transport and PicoVGA multi-core video patterns.
- 2026-01-27: Clarified MacDevDocs relevance as compact Mac video output references (128K through SE/30).
- 2026-01-27: Noted MacDevDocs Classic/Classic II developer note sync wiring and timing references for compact Mac video output.
- 2026-01-27: Searched MacDevDocs with `rg -i "HSYNC|VSYNC" /opt/MacDevDocs` to locate compact Mac sync references.
- 2026-01-27: Switched frame DMA to a single contiguous transfer per frame and abort on VSYNC to remove per-line DMA re-arming.
- 2026-01-27: Align active-line extraction to the end of short frames so captures still transmit when total lines dip below the nominal VBL+active count.
- 2026-01-27: Byte-swapped 32-bit PIO RX FIFO words before enqueueing USB line packets to fix 16/32-pixel block ordering artifacts.
- 2026-01-27: Phase-locked PIXCLK after HSYNC in PIO capture to eliminate intermittent 1-pixel horizontal slips.
- 2026-01-27: Forced PIXCLK phase alignment in PIO capture loops so the first sample always follows a real edge.
- 2026-01-27: Fixed capture length to YOFF+ACTIVE lines and finalized frames on DMA completion instead of VSYNC edges.
- 2026-01-27: Adjusted HSYNC anchoring and XOFF to start sampling earlier, removing persistent horizontal wrap.
- 2026-01-27: Anchored HSYNC to per-mode edges, retuned XOFF to 157 PIXCLK cycles, and added a small post-edge sampling delay.
- 2026-01-26: Restored missing helper scripts for CDC command output and A/B capture testing; documented their usage.
- 2026-01-26: Added ATX soft-power, BOOTSEL, and watchdog reset CDC commands; documented GPIO9 PS_ON output.
- 2026-01-26: Defaulted host test helper to send ATX power-on before capture, wait with diagnostics, and request ATX shutdown on exit.
- 2026-01-26: Adjusted host helper defaults to 12s boot wait with diagnostics during boot.
- 2026-01-25: Initial repo scaffolding (README, agents.md, docs/*, .gitignore).
- 2026-01-25: Documented availability of `/opt/MacDevDocs` as a local reference source.
- 2026-01-24: Expanded documentation with current capture behavior, pin map, and USB CDC packet format for host tooling.
- 2026-01-24: Clarified that `src/host_recv_frames.py` is the host-side test program.
- 2026-01-26: Reset counters before arming capture in `host_recv_frames.py` to avoid stale 100-frame runs.
- 2026-01-26: Added a short boot wait after opening CDC in `host_recv_frames.py`, configurable via `--boot-wait`.
- 2026-01-26: Added `--diag-secs` to `host_recv_frames.py` for printing ASCII status before arming capture.
- 2026-01-26: Allow status output to continue after 100-frame completion and avoid parking the main loop.
- 2026-01-26: Stop capture on host exit and pre-stop before arming in `host_recv_frames.py`.
- 2026-01-26: Stop re-arming DMA after a capture window completes to avoid stale DMA activity between runs.
- 2026-01-26: Adjusted GPIO diagnostic command to use polling-based edge sampling to avoid IRQ overload on PIXCLK.
- 2026-01-26: Added a force-capture CDC command and host fallback to trigger capture when VSYNC gating stalls.
- 2026-01-26: Added a synthetic test-frame CDC command and host option to isolate USB streaming from capture issues.
- 2026-01-26: Prevented force-capture fallback from firing during synthetic test-frame runs.
- 2026-01-26: Added a probe packet command and host probe option to sanity-check CDC raw bytes.
- 2026-01-26: Emit a probe packet when starting a synthetic test frame to confirm CDC output immediately.
- 2026-01-26: Queue probe packets until CDC write space is available to avoid missing probes.
- 2026-01-26: Add a debug CDC command to report internal streaming state on demand.
- 2026-01-26: Added a consolidated Macintosh Classic video timing/sync summary and expanded the source index for mac_classic_video_protocol references.
- 2026-01-25: Stream USB CDC packets in chunks so 72-byte line packets transmit on 64-byte endpoints.
- 2026-01-25: Increase line TX queue depth to buffer a full frame and avoid drops on full-speed USB.
- 2026-01-25: Trigger line capture on HSYNC falling edge to test polarity alignment.
- 2026-01-25: Tune horizontal skip to 178 PIXCLK cycles based on VCD reconstruction sweep.
- 2026-01-25: Add CDC commands to toggle HSYNC/VSYNC edges at runtime for capture testing.
- 2026-01-25: Fix missing gpio_irq forward declaration after adding runtime edge toggles.
- 2026-01-25: Add a runtime CDC toggle for PIXCLK edge selection.
- 2026-01-25: Disable internal pullups/pulldowns on PIXCLK/VIDEO/HSYNC/VSYNC to rely on external termination.

- 2026-02-02: Added an ADB keyboard/mouse implementation plan covering PIO timing, core split, and CDC test channel.
- 2026-02-03: Drop CDC1 debug/status output when the control interface is disconnected or lacks write space, and clear any queued control text on disconnect to prevent backlog flushes.
- 2026-02-03: Expanded mandatory memory checks to include codebase scans and relevant /opt references, with /opt/adb as the overriding source for ADB conflicts.
- 2026-02-03: Switched the video stream from CDC0 to a vendor bulk endpoint and updated host tooling/docs accordingly.
- 2026-02-03: Made the bulk-stream host helper tolerate USB “resource busy” by reusing the active configuration and ignoring EBUSY on set-configuration.
- 2026-02-03: Updated debug/ADB console helper scripts to use the new CDC interface indices (if01 control, if03 ADB).
- 2026-02-03: Handle Ctrl+C cleanly in host_recv_frames.py when reading from the bulk stream to avoid noisy tracebacks.
- 2026-02-11: Replaced the ADB bus state machine with hootswitch’s ISR-driven device-side flow (PIO IRQ + GPIO rise ISR), trimming to a single computer instance while keeping keyboard/mouse devices and the GPIO6/12 pin map.
- 2026-02-11: Switched ADB PIO IRQ enablement to hootswitch-style mask-based configuration for the active state machine.
- 2026-02-11: Aligned ADB handler ID callbacks with hootswitch’s get/set handle model, so reg3 Listen proposals route through driver validation before updating stored handler IDs.
