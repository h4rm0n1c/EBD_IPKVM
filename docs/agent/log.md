# Log (running)

- 2026-02-10: Added a `Boot for ROM disk` start option in the web UI that holds Command+Option+X+O for ~30s after power-on, then releases all keys automatically.
- 2026-02-10: Added web keyboard capture (keydown/keyup + modifier bits) and right-click pointer-lock release so Escape can be passed through as ADB keyboard input.
- 2026-02-10: Reduced web canvas mouse sensitivity to 0.5x before serial packetization so pointer motion matches the 2x upscaled display better.
- 2026-02-10: Added web-client pointer-lock mouse capture and a backend serial bridge that sends MacFriends-format mouse packets to the Arduino ADB core over `/dev/serial/by-id/...` (override via `ADB_SERIAL_PORT`).
- 2026-02-10: Clarified USB enumeration docs: one CDC ACM debug/control function appears as two USB interfaces (Comm + Data), which is expected and still a single tty channel.
- 2026-02-10: Renamed firmware CDC ring symbols to `cdc_ctrl_*` and added a TinyUSB compile-time guard (`CFG_TUD_CDC == 1`) to prevent reintroducing CDC video paths.
- 2026-02-10: Removed deprecated CDC video-feed references, simplified `host_recv_frames.py` to USB bulk video + EP0 control only, and updated web/docs text to treat CDC strictly as control/debug.
- 2026-02-04: Copied MacFriends macOS reference app sources into docs/reference/macfriends for ADB comms reference.
- 2026-02-03: Reimplemented CDC1 ring-buffered control/status output with priority drain, bumped CDC TX buffer, and updated host tooling for CDC auto-detect + interactive relay.
- 2026-02-04: Updated ADB documentation to use the MacFriends Arduino core on an ATmega328p over UART1 (GPIO20/21) and captured the wiring/level-shifting notes.
- 2026-02-03: Fixed host receiver CDC auto-detect initialization order to avoid NameError on startup.
- 2026-02-03: Added scripts/setup_opt_references.sh to install /opt reference corpora including hootswitch and ADB miscdocs.
- 2026-02-03: Updated ADB documentation to reflect hootswitch-based bus planning, AppleCore naming, and GPIO6/12 wiring.
- 2026-02-02: Added --no-read and --no-setup options to scripts/cdc_cmd.py for send-only CDC commands.
- 2026-02-02: Added flash/build and serial console helper scripts under scripts/ for Pico workflows.
- 2026-02-02: Updated the ADB implementation plan to split RX/TX into separate PIO programs and to ignore local TX on the shared ADB line except during loopback validation.
- 2026-02-02: Updated the ADB plan to refer to core1 as KVMCore and to include a rate-limited ADB RX indicator on the CDC test channel.
- 2026-02-02: Noted that ADB validation should cross-check the reference implementations available under /opt/adb.

- 2026-02-02: Updated README with ADB pins, corrected capture geometry, and clarified CDC stream/control interfaces plus host helper defaults.
- 2026-02-01: Added core0/core1 utilization counters to the firmware status output to support time-budgeting work on the video core.
- 2026-02-01: Refined core0/core1 utilization counters to track active USB/capture/TX queue work time instead of full loop occupancy.
- 2026-02-01: Count utilization only when USB/capture/TX routines perform work, avoiding idle-loop inflation.
- 2026-02-01: Split USB CDC into stream (CDC0) and control/status (CDC1) interfaces so status traffic no longer shares the video stream.
- 2026-02-01: Updated host Python tooling to target CDC0 for the stream and CDC1 for control commands by default.
- 2026-02-01: Documented how to identify CDC0/CDC1 in Linux via interface strings and /dev/serial/by-id symlinks.
- 2026-02-02: Documented /opt/adb reference locations in agents.md for local ADB research sources.
- 2026-02-01: Avoid partial CDC1 status writes so log lines don't interleave when control FIFO is tight.
- 2026-02-02: Captured external ADB implementation references and Apple docs links in notes for future input-device emulation work.
- 2026-02-01: Split CDC1 debug/status output into shorter lines so the control interface can emit updates reliably.
- 2026-02-01: Emit CRLF on CDC1 output to keep terminal line breaks aligned across host serial tools.
- 2026-02-01: Disabled frame file writes when streaming raw host data so raw capture no longer fills disks with PGM/PBM output.
- 2026-02-01: Modularized core0 CDC/command handling and core1 capture/encode flow into app_core/video_core with shared stream protocol and core bridge helpers.
- 2026-01-31: Split capture/line encoding onto core1 with a lock-free TX queue to keep core0 focused on CDC I/O and command parsing.
- 2026-01-30: Added a CDC mode toggle for 30 fps test capture versus continuous ~60 fps streaming.
- 2026-01-30: Defaulted capture mode to continuous ~60 fps streaming for testing.
- 2026-01-30: Made raw stream mode in `host_recv_frames.py` run continuously and silence periodic debug output.
- 2026-01-30: Added optional raw 8-bit stream output to `host_recv_frames.py` and switched default output to PGM.
- 2026-01-30: Switched host test output to compact PBM by default with a --pgm fallback for 8-bit frames.
- 2026-01-30: Documented ffmpeg palette generation and GIF assembly commands for host frame captures.
- 2026-01-30: Added optional RLE packet encoding with a CDC toggle and updated host decoding to handle variable-length line payloads (default RLE on).
- 2026-01-30: Added per-frame host-side compression stats (payload vs raw bytes, RLE line counts) to visualize RLE effectiveness.
- 2026-01-30: Switched host compression ratio readout to a percentage for easier scanning.
- 2026-01-29: Lock classic line capture to HSYNC falling + PIXCLK rising and remove runtime edge toggles/program variants to simplify the PIO program set.
- 2026-01-28: Delayed line capture start by 18 PIXCLKs after XOFF to shift sampling into active video and preserve the rightmost pixels.
- 2026-01-27: Switched capture to VSYNC-ended frame boundaries with ping-pong framebuffers and main-loop line packetization to prevent line-count drift.
- 2026-01-27: Added VSYNC debounce and TX-idle gating so frame delivery stays monotonic under backpressure.
- 2026-01-27: Documented /opt reference relevance (MacDevDocs, Pico SDK, PicoHTTPServer) for future KVM work.
- 2026-01-27: Expanded /opt reference notes with SigrokPico RLE transport and PicoVGA multi-core video patterns.
- 2026-01-27: Clarified MacDevDocs relevance as compact Mac video output references (128K through SE/30).
- 2026-01-27: Noted MacDevDocs Classic/Classic II developer note sync wiring and timing references for compact Mac video output.
- 2026-01-27: Searched MacDevDocs with `rg -i "HSYNC|VSYNC" /opt/MacDevDocs` to locate compact Mac sync references.
- 2026-01-27: Switched frame DMA to a single contiguous transfer per frame and abort on VSYNC to remove per-line DMA re-arming.
- 2026-01-27: Align active-line extraction to the end of short frames so captures still transmit when total lines dip below the nominal VBL+active count.
- 2026-01-27: Byte-swapped 32-bit PIO RX FIFO words before enqueueing USB line packets to fix 16/32-pixel block ordering artifacts.
- 2026-01-27: Phase-locked PIXCLK after HSYNC in PIO capture to eliminate intermittent 1-pixel horizontal slips.
- 2026-01-27: Forced PIXCLK phase alignment in PIO capture loops so the first sample always follows a real edge.
- 2026-01-27: Fixed capture length to YOFF+ACTIVE lines and finalized frames on DMA completion instead of VSYNC edges.
- 2026-01-27: Adjusted HSYNC anchoring and XOFF to start sampling earlier, removing persistent horizontal wrap.
- 2026-01-27: Anchored HSYNC to per-mode edges, retuned XOFF to 157 PIXCLK cycles, and added a small post-edge sampling delay.
- 2026-01-26: Restored missing helper scripts for CDC command output and A/B capture testing; documented their usage.
- 2026-01-26: Added ATX soft-power, BOOTSEL, and watchdog reset CDC commands; documented GPIO9 PS_ON output.
- 2026-01-26: Defaulted host test helper to send ATX power-on before capture, wait with diagnostics, and request ATX shutdown on exit.
- 2026-01-26: Adjusted host helper defaults to 12s boot wait with diagnostics during boot.
- 2026-01-25: Initial repo scaffolding (README, agents.md, docs/*, .gitignore).
- 2026-01-25: Documented availability of `/opt/MacDevDocs` as a local reference source.
- 2026-01-24: Expanded documentation with current capture behavior, pin map, and USB CDC packet format for host tooling.
- 2026-01-24: Clarified that `src/host_recv_frames.py` is the host-side test program.
- 2026-01-26: Reset counters before arming capture in `host_recv_frames.py` to avoid stale 100-frame runs.
- 2026-01-26: Added a short boot wait after opening CDC in `host_recv_frames.py`, configurable via `--boot-wait`.
- 2026-01-26: Added `--diag-secs` to `host_recv_frames.py` for printing ASCII status before arming capture.
- 2026-01-26: Allow status output to continue after 100-frame completion and avoid parking the main loop.
- 2026-01-26: Stop capture on host exit and pre-stop before arming in `host_recv_frames.py`.
- 2026-01-26: Stop re-arming DMA after a capture window completes to avoid stale DMA activity between runs.
- 2026-01-26: Adjusted GPIO diagnostic command to use polling-based edge sampling to avoid IRQ overload on PIXCLK.
- 2026-01-26: Added a force-capture CDC command and host fallback to trigger capture when VSYNC gating stalls.
- 2026-01-26: Added a synthetic test-frame CDC command and host option to isolate USB streaming from capture issues.
- 2026-01-26: Prevented force-capture fallback from firing during synthetic test-frame runs.
- 2026-01-26: Added a probe packet command and host probe option to sanity-check CDC raw bytes.
- 2026-01-26: Emit a probe packet when starting a synthetic test frame to confirm CDC output immediately.
- 2026-01-26: Queue probe packets until CDC write space is available to avoid missing probes.
- 2026-01-26: Add a debug CDC command to report internal streaming state on demand.
- 2026-01-26: Added a consolidated Macintosh Classic video timing/sync summary and expanded the source index for mac_classic_video_protocol references.
- 2026-01-25: Stream USB CDC packets in chunks so 72-byte line packets transmit on 64-byte endpoints.
- 2026-01-25: Increase line TX queue depth to buffer a full frame and avoid drops on full-speed USB.
- 2026-01-25: Trigger line capture on HSYNC falling edge to test polarity alignment.
- 2026-01-25: Tune horizontal skip to 178 PIXCLK cycles based on VCD reconstruction sweep.
- 2026-01-25: Add CDC commands to toggle HSYNC/VSYNC edges at runtime for capture testing.
- 2026-01-25: Fix missing gpio_irq forward declaration after adding runtime edge toggles.
- 2026-01-25: Add a runtime CDC toggle for PIXCLK edge selection.
- 2026-01-25: Disable internal pullups/pulldowns on PIXCLK/VIDEO/HSYNC/VSYNC to rely on external termination.

- 2026-02-02: Added an ADB keyboard/mouse implementation plan covering PIO timing, core split, and CDC test channel.

- 2026-02-03: Imported the MacFriends Arduino core snapshot into /Arduino with source/credit notes.
- 2026-02-04: Set the Arduino Uno PlatformIO upload speed to 57600 for the Uno environment.
- 2026-02-04: Aligned the Arduino Uno monitor speed to 57600 to match the updated upload rate.
- 2026-02-04: Added a Duemilanove PlatformIO environment copied from the prior Uno config and restored the Uno speeds to 115200.
- 2026-02-05: Added initial client_web scaffold with README and Devuan setup notes for pipx/serial permissions.
- 2026-02-05: Moved Devuan pipx/serial setup notes into client_web/README.md for quick reference.
- 2026-02-05: Stored the webapp client plan in client_web/docs so progress can be tracked over time.
- 2026-02-05: Added implementation references to the web client plan, highlighting host_recv_frames.py as the primary CDC decode/comms reference.
- 2026-02-05: Clarified that web client setup/usage notes live in client_web/README.md (not docs).
- 2026-02-05: Documented that the web client is single-session/single-client with one set of device connections.
- 2026-02-05: Added a FastAPI-based web client shell with a single-session UI, session API, and CDC1 console placeholder.
- 2026-02-05: Added client_web/requirements.txt and venv install steps to document FastAPI/Uvicorn dependencies.
- 2026-02-05: Ignored client_web/.venv in git to avoid committing local virtualenvs.
- 2026-02-05: Added a client_web pyproject so `pip install -e .` installs the web client module.
- 2026-02-05: Tightened the web client UI layout to fit within a 1080p viewport without scrolling.
- 2026-02-05: Reduced web client UI spacing and typography so the layout is shorter on 1080p screens.
- 2026-02-05: Set the web client video placeholder to 1024x684 (2x target capture size) and adjusted layout sizing.
- 2026-02-05: Reflowed the web client layout into a single column so the video and console panels fit without clipping.
- 2026-02-05: Rebalanced the web client layout into compact side-by-side panels sized to content.
- 2026-02-05: Matched the CDC1 console panel height to the 1024x684 video placeholder.
- 2026-02-05: Standardized video/console panel heights with shared layout variables to stop overlap.
- 2026-02-05: Added box-sizing and a 10px console offset so the CDC1 panel sits cleanly beside the video panel.
- 2026-02-05: Adjusted the video panel column width so the padded container fully contains the 1024px placeholder.
- 2026-02-05: Switched the web client to uvicorn[standard] so WebSocket support is installed by default.
- 2026-02-05: Expanded web client Step 5 to stream in-memory 1-bpp RLE line payloads over WebSocket for parity with the CDC stream and future transport swaps.
- 2026-02-05: Clarified web client Step 5 to buffer full frames in the browser and push decode/render logic client-side for future UDP transport.
- 2026-02-05: Implemented web client Step 5 stream parsing and browser-side frame assembly with CDC line packets over WebSocket.
- 2026-02-05: Documented upgrading the web client venv after dependency changes and made pyserial import lazy to avoid startup crashes without serial.
- 2026-02-05: Added troubleshooting notes for missing pyserial and recorded the editable-install upgrade reminder.
- 2026-02-05: Switched web client streaming to pyusb bulk reads to match host_recv_frames and documented the dependency.
- 2026-02-05: Added a parity-first reminder in AGENTS.md to re-check host_recv_frames before implementing web client transport logic.
- 2026-02-05: Added troubleshooting guidance for missing pyusb (`python3-usb`) in web client docs.
- 2026-02-05: Wired web client start/stop to EP0 control commands (reset, RLE, capture start/stop) to match host_recv_frames behavior.
- 2026-02-05: Added EP0 vendor requests for PS_ON, BOOTSEL, and reboot; documented bulk-first transport and deprecated CDC video stream.
- 2026-02-05: Buffered completed frames for render and moved canvas draws onto requestAnimationFrame to reduce flicker.
- 2026-02-05: Removed boot/diag delays and added EP0 PS_OFF on stop to power down and end capture cleanly.
- 2026-02-05: Rendered the web client canvas at 2x resolution with pixel-doubling to avoid browser scaling blur.
- 2026-02-05: Styled the video panel with beige casing and larger padding to evoke a luggable Mac enclosure.
- 2026-02-05: Adjusted video panel CSS specificity so the beige casing/padding overrides the base panel styling.
- 2026-02-05: Documented LAN access defaults and ensured WebSocket scheme matches http/https.
- 2026-02-05: Logged WebSocket close reasons in the UI and documented single-client WebSocket behavior.
- 2026-02-05: Added a crypto.randomUUID fallback for older browsers without the API.
- 2026-02-05: Noted that crypto.randomUUID may be unavailable on non-secure remote contexts and the UI fallback covers it.
- 2026-02-10: Cleared the web video canvas to black on Stop/WebSocket close and reset frame state so the last captured frame is not left on screen after shutdown.
- 2026-02-10: Restyled the web video panel toward a classic Macintosh Color Display bezel, moved the session note below the bezel, and added a power LED indicator tied to session active/stop state.
- 2026-02-10: Fixed canvas moire risk by pinning web canvas CSS size to exact 1024x684, centering it in the bezel, widening the video column to avoid shrink, and adding pixelated/crisp-edges rendering hints.
- 2026-02-10: Removed the canvas inner vignette overlay to avoid interference patterns on high-frequency dither areas while keeping the bezel lip styling.
- 2026-02-10: Switched browser rendering to a 512x342 source ImageData + nearest-neighbor drawImage upscale path to avoid periodic tile-like artifacts from direct 1024x684 manual pixel writes.
- 2026-02-10: Switched display canvas backing store to native 512x342 with CSS 2x upscale so frames are blitted with putImageData at source resolution and avoid GPU tile artifacts from drawImage scaling.
