# Log (running)

- 2026-02-04: Removed the cached ADB pending-events counter and read adb_events_pending() when emitting stats.
- 2026-02-04: Emit ADB diagnostic lines on CDC2 every second instead of gating on a manual request.
- 2026-02-04: Always respond to ADB keyboard Talk reg0 with 0xFF 0xFF when no key events are queued.
- 2026-02-02: Marked ADB work as in-progress in project state and added a first bring-up checklist to the ADB implementation plan.
- 2026-02-02: Documented that ADB implementation is active and added status guidance in the ADB protocol notes.
- 2026-02-02: Added initial ADB event queue plumbing, CDC2 test input parsing, and RX activity latching for early on-bus validation.
- 2026-02-02: Added initial ADB PIO RX/TX programs plus a PIO1-backed RX pulse capture path in the ADB bus scaffold.
- 2026-02-02: Added CDC1 reconnect/drop counters to aid debugging control channel disconnects during capture.
- 2026-02-02: Hardwired adb_pio RX waits to GPIO6 and removed redundant GPIO sampling to avoid spurious activity during ADB bring-up.
- 2026-02-02: Moved ADB RECV/XMIT pins to GPIO6/GPIO14 for ADB pulse-capture bring-up testing.
- 2026-02-02: Set ADB PIO RX/TX clock divider to 8 and convert RX counts to microseconds before filtering so pulse capture uses real ADB timing.
- 2026-02-02: Exposed ADB raw pulse counts and last pulse width in CDC1 status output to debug missing RX activity.
- 2026-02-02: Set ADB PIO RX to use a joined RX FIFO and non-blocking pushes to avoid stalling when pulses arrive faster than the poller drains.
- 2026-02-02: Extended GPIO diagnostic output to include ADB RECV/XMIT pin levels.
- 2026-02-02: Added a CDC1 `A` command to emit ADB pin levels + pulse stats without interrupting capture.
- 2026-02-02: Updated the ADB implementation plan to split RX/TX into separate PIO programs and to ignore local TX on the shared ADB line except during loopback validation.
- 2026-02-02: Updated the ADB plan to refer to core1 as KVMCore and to include a rate-limited ADB RX indicator on the CDC test channel.
- 2026-02-02: Noted that ADB validation should cross-check the reference implementations available under /opt/adb.

- 2026-02-02: Updated README with ADB pins, corrected capture geometry, and clarified CDC stream/control interfaces plus host helper defaults.
- 2026-02-01: Added core0/core1 utilization counters to the firmware status output to support time-budgeting work on the video core.
- 2026-02-01: Refined core0/core1 utilization counters to track active USB/capture/TX queue work time instead of full loop occupancy.
- 2026-02-01: Count utilization only when USB/capture/TX routines perform work, avoiding idle-loop inflation.
- 2026-02-01: Split USB CDC into stream (CDC0) and control/status (CDC1) interfaces so status traffic no longer shares the video stream.
- 2026-02-01: Updated host Python tooling to target CDC0 for the stream and CDC1 for control commands by default.
- 2026-02-01: Documented how to identify CDC0/CDC1 in Linux via interface strings and /dev/serial/by-id symlinks.
- 2026-02-02: Documented /opt/adb reference locations in agents.md for local ADB research sources.
- 2026-02-01: Avoid partial CDC1 status writes so log lines don't interleave when control FIFO is tight.
- 2026-02-02: Captured external ADB implementation references and Apple docs links in notes for future input-device emulation work.
- 2026-02-01: Split CDC1 debug/status output into shorter lines so the control interface can emit updates reliably.
- 2026-02-01: Emit CRLF on CDC1 output to keep terminal line breaks aligned across host serial tools.
- 2026-02-01: Disabled frame file writes when streaming raw host data so raw capture no longer fills disks with PGM/PBM output.
- 2026-02-01: Modularized core0 CDC/command handling and core1 capture/encode flow into app_core/video_core with shared stream protocol and core bridge helpers.
- 2026-01-31: Split capture/line encoding onto core1 with a lock-free TX queue to keep core0 focused on CDC I/O and command parsing.
- 2026-01-30: Added a CDC mode toggle for 30 fps test capture versus continuous ~60 fps streaming.
- 2026-01-30: Defaulted capture mode to continuous ~60 fps streaming for testing.
- 2026-01-30: Made raw stream mode in `host_recv_frames.py` run continuously and silence periodic debug output.
- 2026-01-30: Added optional raw 8-bit stream output to `host_recv_frames.py` and switched default output to PGM.
- 2026-01-30: Switched host test output to compact PBM by default with a --pgm fallback for 8-bit frames.
- 2026-01-30: Documented ffmpeg palette generation and GIF assembly commands for host frame captures.
- 2026-01-30: Added optional RLE packet encoding with a CDC toggle and updated host decoding to handle variable-length line payloads (default RLE on).
- 2026-01-30: Added per-frame host-side compression stats (payload vs raw bytes, RLE line counts) to visualize RLE effectiveness.
- 2026-01-30: Switched host compression ratio readout to a percentage for easier scanning.
- 2026-01-29: Lock classic line capture to HSYNC falling + PIXCLK rising and remove runtime edge toggles/program variants to simplify the PIO program set.
- 2026-01-28: Delayed line capture start by 18 PIXCLKs after XOFF to shift sampling into active video and preserve the rightmost pixels.
- 2026-01-27: Switched capture to VSYNC-ended frame boundaries with ping-pong framebuffers and main-loop line packetization to prevent line-count drift.
- 2026-01-27: Added VSYNC debounce and TX-idle gating so frame delivery stays monotonic under backpressure.
- 2026-01-27: Documented /opt reference relevance (MacDevDocs, Pico SDK, PicoHTTPServer) for future KVM work.
- 2026-01-27: Expanded /opt reference notes with SigrokPico RLE transport and PicoVGA multi-core video patterns.
- 2026-01-27: Clarified MacDevDocs relevance as compact Mac video output references (128K through SE/30).
- 2026-01-27: Noted MacDevDocs Classic/Classic II developer note sync wiring and timing references for compact Mac video output.
- 2026-01-27: Searched MacDevDocs with `rg -i "HSYNC|VSYNC" /opt/MacDevDocs` to locate compact Mac sync references.
- 2026-01-27: Switched frame DMA to a single contiguous transfer per frame and abort on VSYNC to remove per-line DMA re-arming.
- 2026-01-27: Align active-line extraction to the end of short frames so captures still transmit when total lines dip below the nominal VBL+active count.
- 2026-01-27: Byte-swapped 32-bit PIO RX FIFO words before enqueueing USB line packets to fix 16/32-pixel block ordering artifacts.
- 2026-01-27: Phase-locked PIXCLK after HSYNC in PIO capture to eliminate intermittent 1-pixel horizontal slips.
- 2026-01-27: Forced PIXCLK phase alignment in PIO capture loops so the first sample always follows a real edge.
- 2026-01-27: Fixed capture length to YOFF+ACTIVE lines and finalized frames on DMA completion instead of VSYNC edges.
- 2026-01-27: Adjusted HSYNC anchoring and XOFF to start sampling earlier, removing persistent horizontal wrap.
- 2026-01-27: Anchored HSYNC to per-mode edges, retuned XOFF to 157 PIXCLK cycles, and added a small post-edge sampling delay.
- 2026-01-26: Restored missing helper scripts for CDC command output and A/B capture testing; documented their usage.
- 2026-01-26: Added ATX soft-power, BOOTSEL, and watchdog reset CDC commands; documented GPIO9 PS_ON output.
- 2026-01-26: Defaulted host test helper to send ATX power-on before capture, wait with diagnostics, and request ATX shutdown on exit.
- 2026-01-26: Adjusted host helper defaults to 12s boot wait with diagnostics during boot.
- 2026-01-25: Initial repo scaffolding (README, agents.md, docs/*, .gitignore).
- 2026-01-25: Documented availability of `/opt/MacDevDocs` as a local reference source.
- 2026-01-24: Expanded documentation with current capture behavior, pin map, and USB CDC packet format for host tooling.
- 2026-01-24: Clarified that `src/host_recv_frames.py` is the host-side test program.
- 2026-01-26: Reset counters before arming capture in `host_recv_frames.py` to avoid stale 100-frame runs.
- 2026-01-26: Added a short boot wait after opening CDC in `host_recv_frames.py`, configurable via `--boot-wait`.
- 2026-01-26: Added `--diag-secs` to `host_recv_frames.py` for printing ASCII status before arming capture.
- 2026-01-26: Allow status output to continue after 100-frame completion and avoid parking the main loop.
- 2026-01-26: Stop capture on host exit and pre-stop before arming in `host_recv_frames.py`.
- 2026-01-26: Stop re-arming DMA after a capture window completes to avoid stale DMA activity between runs.
- 2026-01-26: Adjusted GPIO diagnostic command to use polling-based edge sampling to avoid IRQ overload on PIXCLK.
- 2026-01-26: Added a force-capture CDC command and host fallback to trigger capture when VSYNC gating stalls.
- 2026-01-26: Added a synthetic test-frame CDC command and host option to isolate USB streaming from capture issues.
- 2026-01-26: Prevented force-capture fallback from firing during synthetic test-frame runs.
- 2026-01-26: Added a probe packet command and host probe option to sanity-check CDC raw bytes.
- 2026-01-26: Emit a probe packet when starting a synthetic test frame to confirm CDC output immediately.
- 2026-01-26: Queue probe packets until CDC write space is available to avoid missing probes.
- 2026-01-26: Add a debug CDC command to report internal streaming state on demand.
- 2026-01-26: Added a consolidated Macintosh Classic video timing/sync summary and expanded the source index for mac_classic_video_protocol references.
- 2026-01-25: Stream USB CDC packets in chunks so 72-byte line packets transmit on 64-byte endpoints.
- 2026-01-25: Increase line TX queue depth to buffer a full frame and avoid drops on full-speed USB.
- 2026-01-25: Trigger line capture on HSYNC falling edge to test polarity alignment.
- 2026-01-25: Tune horizontal skip to 178 PIXCLK cycles based on VCD reconstruction sweep.
- 2026-01-25: Add CDC commands to toggle HSYNC/VSYNC edges at runtime for capture testing.
- 2026-01-25: Fix missing gpio_irq forward declaration after adding runtime edge toggles.
- 2026-01-25: Add a runtime CDC toggle for PIXCLK edge selection.
- 2026-01-25: Disable internal pullups/pulldowns on PIXCLK/VIDEO/HSYNC/VSYNC to rely on external termination.

- 2026-02-02: Added an ADB keyboard/mouse implementation plan covering PIO timing, core split, and CDC test channel.
- 2026-02-03: Capped ADB RX pulse handling per poll iteration and exposed an overrun counter to avoid core1 starvation when the ADB line is active.
- 2026-02-03: Flush ADB RX FIFO on backlog overruns so core1 stays responsive while still sampling new ADB activity.
- 2026-02-03: Allow ~35 µs ADB low pulses in the RX filter window and tie ADB RX PIO waits to the configured pin base.
- 2026-02-03: Moved ADB diagnostic/status output to CDC2 to keep CDC1 focused on control/status traffic.
- 2026-02-03: Allow ADB diagnostic requests to be triggered from CDC2 as well as CDC1.
- 2026-02-03: Make scripts/cdc_cmd.py tolerate CDC disconnects and add a --no-read option for reset/BOOTSEL commands.
- 2026-02-03: Handle ADB diag requests only on CDC2 to keep CDC1 control traffic clean.
- 2026-02-03: Added attention/sync pulse counters to CDC2 ADB status output for early frame-boundary validation.
- 2026-02-03: Added a --no-setup option to cdc_cmd.py to skip termios/DTR when sending BOOTSEL commands.
- 2026-02-03: Emit the 1Hz ADB status line on CDC2 even when CDC1 is disconnected.
- 2026-02-03: Chunk and flush CDC2 ADB status writes to avoid silent drops when write space is low.
- 2026-02-03: Widened the ADB attention pulse window during bring-up to catch attention edges shortened by capture skew.
- 2026-02-03: Added ADB pulse-width bin counters and min/max reporting to the CDC2 ADB diagnostic output.
- 2026-02-03: Treat zero-length RX pulse samples as a separate bin to avoid skewing min/max during ADB capture debugging.
- 2026-02-03: Corrected ADB RX pulse-width conversion to account for two PIO cycles per loop iteration in the RX counter.
- 2026-02-04: Tightened the ADB attention pulse window to 700–900 µs after reviewing diagnostic buckets.
- 2026-02-04: Split ADB pulse-width bins around the attention window to report 600–700, 700–900, and 900–1100 µs counts separately.
- 2026-02-04: Added a basic ADB RX state machine to decode attention+sync command bytes and expose cmd/cmds in CDC2 status output.
- 2026-02-04: Added a CDC2 Ctrl-B macro to hold Command+Option+X+O for ROM-boot testing and documented bus coexistence planning.
- 2026-02-04: Auto-trigger the ROM-boot key hold once after the first decoded ADB command byte to confirm bus activity without manual input.
- 2026-02-04: Increased the ROM-boot key hold duration to ~30 seconds for better startup coverage.
- 2026-02-04: Expose pending ADB event counts in CDC2 status output to confirm ROM-boot key holds are queued.
- 2026-02-04: Added a minimal ADB Talk response for keyboard register 0 (address 2) so queued CDC2 key events can transmit on-bus.
- 2026-02-04: Adjusted ADB TX pulse cycle conversion to account for the single-cycle TX loop and the `set pindirs` assert overhead.
- 2026-02-04: Documented PIO loop cycle accounting as a required step when converting ADB RX/TX ticks to microseconds.
