# Notes

- Local reference: `/opt/MacDevDocs` contains Apple legacy Mac documentation to consult when needed for this project.
- Local reference: `/opt/Pico-SDK` and `/opt/PicoHTTPServer` are available for Pico SDK API details and Pico W captive-portal web UI patterns.
- Local reference: `/opt/SigrokPico` documents USB CDC RLE streaming patterns, and `/opt/picovga` shows a core1 video pipeline split for RP2040.
- MacDevDocs includes Macintosh Classic and Classic II developer notes; Classic lists /VSYNC and /HSYNC on the power/sweep connector and Classic II documents 512×342 internal video timing (EAGLE-generated).
- ATX `PS_ON` is driven through a ULN2803, so GPIO9 high asserts the PSU on (active-low at the ATX header).
- PIXCLK phase-lock after HSYNC (and a pre-roll high before falling-edge capture) prevents occasional 1-pixel capture phase slips.
- If HSYNC edge polarity is ever changed from the default, retune XOFF before enabling capture; otherwise the window can straddle horizontal blanking and produce a stable but incorrect black band.
- `scripts/cdc_cmd.py` is a quick helper for sending CDC command bytes and reading ASCII responses.
- Control/status traffic now uses CDC1 while CDC0 is reserved for the binary video stream; host tooling must open the second CDC interface for commands.
- Host scripts default to `/dev/ttyACM0` for the CDC0 stream and `/dev/ttyACM1` for CDC1 control unless overridden.
- Linux udev symlinks include `if00` (CDC0 stream) and `if02` (CDC1 control); use `/dev/serial/by-id` for stable naming.
- `scripts/ab_capture.py` expects firmware support for the `O` command to toggle VIDEO inversion between runs.
- Classic compact Mac video timing: dot clock ~15.6672 MHz, HSYNC ~22.25 kHz (≈45 µs line), VSYNC ~60.15 Hz with ~180 µs low pulse; HSYNC continues during VSYNC and DATA idles high between active pixels.
- Classic compact Mac HSYNC and VIDEO polarity are inverted compared to TTL PC monitor expectations (VSYNC polarity matches).
- ADB implementation references: hootswitch (`/opt/adb/hootswitch`, PIO + DMA bus engine), trabular (https://github.com/saybur/trabular), tashtrio (https://github.com/lampmerchant/tashtrio), adb-test-device (https://github.com/lampmerchant/adb-test-device), QuokkADB firmware (https://github.com/rabbitholecomputing/QuokkADB-firmware), HIDHopper_ADB (https://github.com/TechByAndroda/HIDHopper_ADB), adbuino (https://github.com/akuker/adbuino), adb-usb (https://github.com/gblargg/adb-usb), Apple ADB Manager PDF (https://developer.apple.com/library/archive/documentation/mac/pdf/Devices/ADB_Manager.pdf), Apple HW technote hw_01 (https://developer.apple.com/legacy/library/technotes/hw/hw_01.html#Extended), Microchip AN591B (`/opt/adb/miscdocs/an591b.pdf`).
  - Hootswitch `bus.pio` includes host+device TX/RX/attention programs; device-side logic lives in `computer.c` and shows collision detection + SRQ gating suitable for us to adapt.

- ADB timing reference: trabular notes that the serial handler must run roughly every 50–70 µs and defines timing windows for attention/sync/bit pulses in its ADB bus implementation.
- ADB default device addresses in trabular: keyboard=2, mouse=3; handler IDs reset alongside addresses on bus reset.
- Observed on hardware: host asserts an ADB reset pulse (~4 ms low, measured 3979 us) about 1 ms before the initial Talk $0 r3 0F..FF traffic during power-on; potential timing reference for future sync.
- ADB RX/TX are tied to the same shared bus; plan to filter out local TX from RX processing except when explicitly testing loopback timing.
- Current board wiring: GPIO6 is ADB RECV (non-inverting) and GPIO12 is ADB XMIT (inverted open-collector), so PIO output polarity must account for the inversion.
- ADB CDC test channel should emit a rate-limited RX-activity line when valid ADB traffic is observed, to confirm host queries are being received.
- ADB CDC2 test input currently treats ASCII bytes as key events (press+release) and uses arrow-key escape sequences plus `Ctrl+R` (`0x12`) to toggle the primary mouse button.
- Validate ADB behavior against the reference implementations stored in `/opt/adb` during bring-up.
- ADB SRQ pulses are now handled by the hootswitch device-side PIO (bus_rx_dev), removing the prior software-timed SRQ pulse logic.
- CDC2 ASCII input now maps through the US ADB keycode table (no modifier synthesis yet), so shifted characters will be sent as their unshifted keycodes for early testing.
- ADB RX is now held off until a low→high transition on the bus; the RX state machine stays disabled and FIFOs are cleared while the line is held low to avoid phantom RX activity when the Mac is off.
- Observed on hardware: with the Mac off, the ADB bus idles low; on power-up it rises high, then drops low for ~3.979 ms, and about 1 ms later the first host Talk traffic appears.
- ADB RX activity is now latched only when a command or listen payload completes (timeout), rather than on every sampled bit, to reduce false “RX seen” noise during idle.
- ADB PIO programs now use hootswitch’s device-side bus implementation (GPLv3); license text is stored in `licenses/hootswitch-GPLv3.txt`.
- ADB reg3 Talk responses now use hootswitch’s randomized low nibble (not the device’s current address) to match hootswitch address-resolution behavior.
- Talk register payloads are now guarded by a hootswitch-style semaphore; Talk commands will treat locked registers as empty to avoid partial reads.
- Reg3 Talk responses are suppressed if the device handler ID is 0xFF (hootswitch-style “no reg3” gating).
- SRQ pending flags are only asserted when SRQ is enabled on the device, matching hootswitch reg0 queue behavior.
- Listen writes shorter than 2 bytes now clear Talk register data (and reg0 SRQ), matching hootswitch Talk length rules.
- Reg3 Listen writes shorter than 2 bytes are ignored, matching hootswitch’s reg3 length handling.
- ADB bus now tracks hootswitch-style lock-failure and collision counters; they are exposed in the CDC debug output.
- Reg3 handler IDs are now sourced via a callback, matching hootswitch’s dynamic handler selection.
- Reg0 queue drain now uses per-device pop callbacks and only fills when reg0 is empty and the lock is available (hootswitch queue-drain semantics).
- Setter APIs are available to bind per-device reg0 pop and handler-ID callbacks for hootswitch-style driver queue integration.
- Mouse reg0 payloads are now buffered in a per-device queue so Talk 0 drain follows hootswitch queue semantics.
- Keyboard reg0 payloads are now buffered in a per-device queue so Talk 0 drain follows hootswitch queue semantics.
- Reg0 pop callbacks now accept a queue-context pointer so driver-owned queues can supply Talk 0 payloads.
- ADB reg0 pop + handler ID callbacks are now bound via the adb_driver layer, and bus resets no longer overwrite those callbacks, preserving driver-owned queue wiring.
- ADB bus debug counters now track attention, short attention, reset, abort, and error events plus the last abort timestamp, matching hootswitch-style diagnostics.
- Handler ID policy now matches hootswitch: keyboard accepts 0x01-0x03; mouse accepts 0x01/0x02/0x04 (invalid IDs fall back to 0x01 in adb_driver).
- Reg3 Listen address updates now clear the SRQ bit when SRQ is disabled, mirroring hootswitch’s SRQ flag clearing behavior.
- Attention completion now relies on a GPIO rising-edge IRQ (hootswitch-style) to decide reset vs command, rather than polling the line level.
- Command completion now follows the hootswitch flow: stop-bit IRQ transitions into an SRQ phase and waits for the GPIO rise before executing Talk/Listen.
- SRQ pending state now tracks a hootswitch-style bitfield keyed by device address, and SRQ gating uses that shared mask.
- ADB validation checklist lives in `docs/protocol/adb.md`, covering scope/logic analyzer timing checks plus CDC2 input validation steps.
- GPIO IRQ callbacks are per-core; using `gpio_set_irq_enabled_with_callback` for VSYNC overwrites the ADB callback, so ADB must use a raw IO_IRQ_BANK0 handler (hootswitch-style) to avoid losing ADB rise events.
- The ADB raw IRQ handler must acknowledge all pending GPIO IRQ bits for the pin; leaving an unacked edge can retrigger the IRQ and starve the main loop (seen as a CDC freeze).
- PIO must explicitly set the ADB TX pin direction/output mask (GPIO12) after claiming the state machine; without that, the PIO sideset will not drive the ULN2803.
- ADB Talk debug counters (empty responses + total bytes) now report if Talk replies are actually being emitted.
- ADB GPIO rise IRQs should disable themselves in the raw handler (hootswitch-style) to avoid IRQ storms that can stall the core.
- CDC1 debug dumps are now emitted as a single buffered block and retried if the control endpoint lacks space, with periodic status paused while a debug dump is pending to avoid dropping late debug lines (e.g., Talk counters).
- Periodic CDC1 status is now emitted as a single buffered block to reduce control endpoint churn and avoid partial status writes when host reads are slow.
- CDC1 debug/status blocks can exceed TinyUSB's per-interface write-available size; queue and chunk long control text to avoid repeated retries and timing side effects during capture.
- CDC1 text output is now gated by video_core_can_emit_text so status/debug lines pause during active capture, avoiding CDC1 bandwidth contention that can disturb the video stream.
