<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EBD IPKVM Web Client (Prototype)</title>
    <style>
      :root {
        color-scheme: dark;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        --video-width: 1024px;
        --video-height: 684px;
        --panel-height: 760px;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: #0e1117;
        color: #f5f5f5;
        display: flex;
        flex-direction: column;
      }
      header {
        padding: 12px 20px;
        border-bottom: 1px solid #1f2430;
      }
      header h1 {
        font-size: 1.2rem;
        margin: 0 0 4px;
      }
      main {
        display: grid;
        grid-template-columns: var(--video-width) 320px;
        gap: 16px;
        padding: 12px 20px 16px;
        flex: 1;
        min-height: 0;
        max-width: 100%;
        margin: 0 auto;
        justify-content: center;
        align-items: start;
      }
      .video-panel {
        width: var(--video-width);
        height: var(--panel-height);
        display: flex;
        flex-direction: column;
      }
      .panel {
        background: #151a23;
        border: 1px solid #1f2430;
        border-radius: 12px;
        padding: 12px;
      }
      .controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 8px;
      }
      button {
        border: none;
        border-radius: 8px;
        padding: 8px 12px;
        font-weight: 600;
        cursor: pointer;
      }
      button.primary {
        background: #3b82f6;
        color: #fff;
      }
      button.secondary {
        background: #2f3645;
        color: #fff;
      }
      .status {
        font-size: 0.85rem;
        color: #9aa4b2;
        margin: 4px 0 0;
      }
      .video-canvas {
        width: var(--video-width);
        height: var(--video-height);
        border-radius: 10px;
        background: #0b0f17;
        border: 1px dashed #2f3645;
        display: grid;
        place-items: center;
        color: #5f6b7a;
        font-size: 0.9rem;
      }
      .console {
        display: flex;
        flex-direction: column;
        gap: 8px;
        height: var(--panel-height);
        align-self: start;
      }
      .console h2 {
        margin: 0;
        font-size: 1rem;
      }
      .console-log {
        flex: 1;
        background: #0b0f17;
        border-radius: 8px;
        border: 1px solid #2a3242;
        padding: 10px;
        font-family: "JetBrains Mono", "Fira Code", monospace;
        font-size: 0.8rem;
        overflow-y: auto;
        white-space: pre-wrap;
      }
      .console-input {
        display: flex;
        gap: 8px;
      }
      .console-input input {
        flex: 1;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #2a3242;
        background: #0b0f17;
        color: #fff;
      }
      .note {
        font-size: 0.8rem;
        color: #9aa4b2;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>EBD IPKVM Web Client</h1>
      <p class="status" id="session-status">Status: idle (single-session, single-client)</p>
    </header>
    <main>
      <section class="panel video-panel">
        <div class="controls">
          <button class="primary" id="start-btn">Start Capture / Boot Mac</button>
          <button class="secondary" id="stop-btn">Stop</button>
        </div>
        <div class="video-canvas" id="video-canvas">Video stream placeholder (1024 Ã— 684)</div>
        <p class="note">
          The backend stays idle until you start a session. Only one browser session can own the
          Pico + CDC connections at a time.
        </p>
      </section>
      <section class="panel console">
        <h2>CDC1 Live Console</h2>
        <div class="console-log" id="console-log"></div>
        <div class="console-input">
          <input id="console-input" type="text" placeholder="Type and press Enter..." />
        </div>
      </section>
    </main>
    <script>
      const consoleLog = document.getElementById("console-log");
      const sessionStatus = document.getElementById("session-status");
      const input = document.getElementById("console-input");
      const startBtn = document.getElementById("start-btn");
      const stopBtn = document.getElementById("stop-btn");

      const appendLog = (message) => {
        const line = document.createElement("div");
        line.textContent = message;
        consoleLog.appendChild(line);
        consoleLog.scrollTop = consoleLog.scrollHeight;
      };

      const ownerId = `browser-${crypto.randomUUID()}`;

      const updateStatus = async () => {
        const response = await fetch("/api/session/status");
        const data = await response.json();
        const active = data.active ? "active" : "idle";
        sessionStatus.textContent = `Status: ${active} (single-session, single-client)`;
      };

      startBtn.addEventListener("click", async () => {
        const response = await fetch("/api/session/start", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ owner_id: ownerId }),
        });
        const data = await response.json();
        appendLog(`[session] ${data.message}`);
        updateStatus();
      });

      stopBtn.addEventListener("click", async () => {
        const response = await fetch("/api/session/stop", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ owner_id: ownerId }),
        });
        const data = await response.json();
        appendLog(`[session] ${data.message}`);
        updateStatus();
      });

      input.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          const message = input.value.trim();
          if (message && socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ type: "console_input", message }));
            input.value = "";
          }
        }
      });

      const socket = new WebSocket(`ws://${window.location.host}/ws`);
      socket.addEventListener("message", (event) => {
        const data = JSON.parse(event.data);
        if (data.message) {
          appendLog(data.message);
        }
      });
      socket.addEventListener("close", () => {
        appendLog("[ws] Connection closed.");
      });

      updateStatus();
    </script>
  </body>
</html>
